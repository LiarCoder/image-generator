const { spawn } = require("child_process");
const fs = require("fs").promises;
const path = require("path");
const os = require("os");

/**
 * CLIé›†æˆæµ‹è¯•
 * æµ‹è¯•å®Œæ•´çš„å‘½ä»¤è¡Œè°ƒç”¨æµç¨‹ï¼ŒéªŒè¯ä¸åŒå‚æ•°ç»„åˆçš„æ­£ç¡®æ€§ï¼Œæµ‹è¯•é”™è¯¯åœºæ™¯å’Œè¾¹ç•Œæ¡ä»¶
 */
describe("CLI Integration Tests", () => {
  let tempDir;
  let originalCwd;
  let canvasAvailable = false;

  beforeAll(async () => {
    // åˆ›å»ºä¸´æ—¶æµ‹è¯•ç›®å½•
    tempDir = await fs.mkdtemp(path.join(os.tmpdir(), "image-gen-test-"));
    originalCwd = process.cwd();

    // æ£€æŸ¥canvasæ¨¡å—æ˜¯å¦å¯ç”¨
    try {
      require("canvas");
      canvasAvailable = true;
    } catch (error) {
      canvasAvailable = false;
      console.warn("Canvasæ¨¡å—ä¸å¯ç”¨ï¼Œå°†è·³è¿‡éœ€è¦å®é™…å›¾ç‰‡ç”Ÿæˆçš„æµ‹è¯•");
    }
  });

  afterAll(async () => {
    // æ¸…ç†ä¸´æ—¶ç›®å½•
    try {
      await fs.rmdir(tempDir, { recursive: true });
    } catch (error) {
      console.warn("æ¸…ç†ä¸´æ—¶ç›®å½•å¤±è´¥:", error.message);
    }
    process.chdir(originalCwd);
  });

  beforeEach(async () => {
    // æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†ä¸´æ—¶ç›®å½•
    try {
      const files = await fs.readdir(tempDir);
      await Promise.all(
        files.map((file) => fs.unlink(path.join(tempDir, file)))
      );
    } catch (error) {
      // å¿½ç•¥æ¸…ç†é”™è¯¯
    }
  });

  /**
   * æ‰§è¡ŒCLIå‘½ä»¤çš„è¾…åŠ©å‡½æ•°
   * @param {string[]} args - å‘½ä»¤è¡Œå‚æ•°
   * @param {Object} options - æ‰§è¡Œé€‰é¡¹
   * @returns {Promise<Object>} æ‰§è¡Œç»“æœ
   */
  function runCLI(args, options = {}) {
    return new Promise((resolve) => {
      const cliPath = path.join(__dirname, "../bin/image-gen.js");
      const child = spawn("node", [cliPath, ...args], {
        cwd: options.cwd || tempDir,
        stdio: ["pipe", "pipe", "pipe"],
        ...options,
      });

      let stdout = "";
      let stderr = "";

      child.stdout.on("data", (data) => {
        stdout += data.toString();
      });

      child.stderr.on("data", (data) => {
        stderr += data.toString();
      });

      child.on("close", (code) => {
        resolve({
          code,
          stdout,
          stderr,
        });
      });

      // è®¾ç½®è¶…æ—¶
      setTimeout(() => {
        child.kill("SIGTERM");
        resolve({
          code: -1,
          stdout,
          stderr: stderr + "\næµ‹è¯•è¶…æ—¶",
        });
      }, 10000); // 10ç§’è¶…æ—¶
    });
  }

  /**
   * æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶è·å–æ–‡ä»¶ä¿¡æ¯
   * @param {string} filePath - æ–‡ä»¶è·¯å¾„
   * @returns {Promise<Object|null>} æ–‡ä»¶ä¿¡æ¯æˆ–null
   */
  async function getFileInfo(filePath) {
    try {
      const stats = await fs.stat(filePath);
      return {
        exists: true,
        size: stats.size,
        isFile: stats.isFile(),
      };
    } catch (error) {
      return { exists: false };
    }
  }

  describe("æˆåŠŸåœºæ™¯æµ‹è¯•", () => {
    test("åº”è¯¥æˆåŠŸç”ŸæˆåŸºæœ¬çš„JPGå›¾ç‰‡", async () => {
      if (!canvasAvailable) {
        // å¦‚æœcanvasä¸å¯ç”¨ï¼Œæµ‹è¯•åº”è¯¥è¿”å›é”™è¯¯ç 3å¹¶æ˜¾ç¤ºç›¸åº”é”™è¯¯ä¿¡æ¯
        const result = await runCLI(["-s", "1"]);

        expect(result.code).toBe(3);
        expect(result.stdout).toContain("å¼€å§‹ç”Ÿæˆå›¾ç‰‡");
        expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 1MB");
        expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼: JPG");
        expect(result.stdout).toContain("Canvasæ¨¡å—é”™è¯¯");
        expect(result.stdout).toContain("è¯·å®‰è£…canvas");
        return;
      }

      const result = await runCLI(["-s", "1"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("å¼€å§‹ç”Ÿæˆå›¾ç‰‡");
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 1MB");
      expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼: JPG");
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");
      expect(result.stderr).toBe("");

      // æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      const files = await fs.readdir(tempDir);
      const jpgFiles = files.filter((f) => f.endsWith(".jpg"));
      expect(jpgFiles.length).toBe(1);

      const fileInfo = await getFileInfo(path.join(tempDir, jpgFiles[0]));
      expect(fileInfo.exists).toBe(true);
      expect(fileInfo.isFile).toBe(true);
      expect(fileInfo.size).toBeGreaterThan(0);
    }, 15000);

    test("åº”è¯¥æˆåŠŸç”ŸæˆPNGæ ¼å¼å›¾ç‰‡", async () => {
      const result = await runCLI(["-s", "2", "-f", "png"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼: PNG");
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");

      const files = await fs.readdir(tempDir);
      const pngFiles = files.filter((f) => f.endsWith(".png"));
      expect(pngFiles.length).toBe(1);
    }, 15000);

    test("åº”è¯¥æˆåŠŸç”Ÿæˆè‡ªå®šä¹‰æ–‡ä»¶åçš„å›¾ç‰‡", async () => {
      const customName = "test-image";
      const result = await runCLI(["-s", "1", "-n", customName]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain(`æ–‡ä»¶å: ${customName}`);

      const files = await fs.readdir(tempDir);
      const customFiles = files.filter((f) => f.startsWith(customName));
      expect(customFiles.length).toBe(1);
      expect(customFiles[0]).toBe(`${customName}.jpg`);
    }, 15000);

    test("åº”è¯¥æˆåŠŸç”ŸæˆJPEGæ ¼å¼å›¾ç‰‡", async () => {
      const result = await runCLI(["-s", "1", "-f", "jpeg"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼: JPEG");

      const files = await fs.readdir(tempDir);
      const jpegFiles = files.filter((f) => f.endsWith(".jpeg"));
      expect(jpegFiles.length).toBe(1);
    }, 15000);

    test("åº”è¯¥æ”¯æŒå°æ•°ä½“ç§¯å€¼", async () => {
      const result = await runCLI(["-s", "0.5"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 0.5MB");
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");
    }, 15000);

    test("åº”è¯¥æ”¯æŒæŒ‡å®šè¾“å‡ºç›®å½•", async () => {
      const outputDir = path.join(tempDir, "output");
      await fs.mkdir(outputDir, { recursive: true });

      const result = await runCLI(["-s", "1", "-o", outputDir]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");

      const files = await fs.readdir(outputDir);
      expect(files.length).toBe(1);
      expect(files[0]).toMatch(/\.jpg$/);
    }, 15000);

    test("åº”è¯¥æ”¯æŒå®Œæ•´å‚æ•°ç»„åˆ", async () => {
      const outputDir = path.join(tempDir, "full-test");
      await fs.mkdir(outputDir, { recursive: true });

      const result = await runCLI([
        "-s",
        "1.5",
        "-f",
        "png",
        "-n",
        "full-test-image",
        "-o",
        outputDir,
      ]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 1.5MB");
      expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼: PNG");
      expect(result.stdout).toContain("æ–‡ä»¶å: full-test-image");
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");

      const files = await fs.readdir(outputDir);
      expect(files).toContain("full-test-image.png");
    }, 15000);

    test("åº”è¯¥æ˜¾ç¤ºè¯¦ç»†çš„ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯", async () => {
      const result = await runCLI(["-s", "2"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("ğŸ“Š ç”Ÿæˆç»Ÿè®¡:");
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 2MB");
      expect(result.stdout).toContain("å®é™…ä½“ç§¯:");
      expect(result.stdout).toContain("ä½“ç§¯è¯¯å·®:");
      expect(result.stdout).toContain("å›¾ç‰‡å°ºå¯¸:");
      expect(result.stdout).toContain("è¿­ä»£æ¬¡æ•°:");
      expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼:");
      expect(result.stdout).toContain("æ–‡ä»¶è·¯å¾„:");
    }, 15000);
  });

  describe("å‚æ•°éªŒè¯æµ‹è¯•", () => {
    test("åº”è¯¥æ‹’ç»ç¼ºå°‘å¿…éœ€å‚æ•°", async () => {
      const result = await runCLI([]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("ä½¿ç”¨ --help æŸ¥çœ‹ä½¿ç”¨è¯´æ˜");
    });

    test("åº”è¯¥æ‹’ç»æ— æ•ˆçš„ä½“ç§¯å€¼", async () => {
      const result = await runCLI(["-s", "invalid"]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("æ— æ•ˆçš„ä½“ç§¯å€¼");
    });

    test("åº”è¯¥æ‹’ç»é›¶ä½“ç§¯", async () => {
      const result = await runCLI(["-s", "0"]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("ä½“ç§¯å¿…é¡»å¤§äº0");
    });

    test("åº”è¯¥æ‹’ç»è´Ÿä½“ç§¯", async () => {
      const result = await runCLI(["-s", "-5"]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("ä½“ç§¯å¿…é¡»å¤§äº0");
    });

    test("åº”è¯¥æ‹’ç»è¿‡å¤§çš„ä½“ç§¯", async () => {
      const result = await runCLI(["-s", "1001"]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("ä½“ç§¯è¿‡å¤§");
    });

    test("åº”è¯¥æ‹’ç»ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼", async () => {
      const result = await runCLI(["-s", "1", "-f", "gif"]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼");
    });

    test("åº”è¯¥æ‹’ç»åŒ…å«éæ³•å­—ç¬¦çš„æ–‡ä»¶å", async () => {
      const result = await runCLI(["-s", "1", "-n", "file<name"]);

      expect(result.code).toBe(2);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("æ–‡ä»¶ååŒ…å«éæ³•å­—ç¬¦");
    });

    test("åº”è¯¥æ‹’ç»ç©ºæ–‡ä»¶å", async () => {
      const result = await runCLI(["-s", "1", "-n", ""]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("æ–‡ä»¶åä¸èƒ½ä¸ºç©º");
    });

    test("åº”è¯¥æ‹’ç»ç©ºè¾“å‡ºç›®å½•", async () => {
      const result = await runCLI(["-s", "1", "-o", ""]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("è¾“å‡ºç›®å½•ä¸èƒ½ä¸ºç©º");
    });
  });

  describe("è¾¹ç•Œæ¡ä»¶æµ‹è¯•", () => {
    test("åº”è¯¥å¤„ç†æœ€å°ä½“ç§¯å€¼", async () => {
      const result = await runCLI(["-s", "0.1"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 0.1MB");
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");
    }, 15000);

    test("åº”è¯¥å¤„ç†å¤§ä½“ç§¯å€¼", async () => {
      const result = await runCLI(["-s", "25"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 25MB");
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");
    }, 30000); // å¤§æ–‡ä»¶éœ€è¦æ›´é•¿æ—¶é—´

    test("åº”è¯¥å¤„ç†æ ¼å¼å¤§å°å†™ä¸æ•æ„Ÿ", async () => {
      const result = await runCLI(["-s", "1", "-f", "PNG"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼: PNG");

      const files = await fs.readdir(tempDir);
      const pngFiles = files.filter((f) => f.endsWith(".png"));
      expect(pngFiles.length).toBe(1);
    }, 15000);

    test("åº”è¯¥å¤„ç†æ–‡ä»¶åå‰åç©ºæ ¼", async () => {
      const result = await runCLI(["-s", "1", "-n", "  spaced-name  "]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");

      const files = await fs.readdir(tempDir);
      const spacedFiles = files.filter((f) => f.startsWith("spaced-name"));
      expect(spacedFiles.length).toBe(1);
    }, 15000);

    test("åº”è¯¥å¤„ç†ä¸å­˜åœ¨çš„è¾“å‡ºç›®å½•", async () => {
      const nonExistentDir = path.join(tempDir, "non-existent");
      const result = await runCLI(["-s", "1", "-o", nonExistentDir]);

      expect(result.code).toBe(2);
      expect(result.stderr).toContain("é”™è¯¯");
    });

    test("åº”è¯¥å¤„ç†æ–‡ä»¶åå†²çª", async () => {
      const fileName = "conflict-test";

      // å…ˆç”Ÿæˆä¸€ä¸ªæ–‡ä»¶
      const result1 = await runCLI(["-s", "1", "-n", fileName]);
      expect(result1.code).toBe(0);

      // å†ç”ŸæˆåŒåæ–‡ä»¶
      const result2 = await runCLI(["-s", "1", "-n", fileName]);
      expect(result2.code).toBe(0);

      // åº”è¯¥æœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œç¬¬äºŒä¸ªæœ‰æ•°å­—åç¼€
      const files = await fs.readdir(tempDir);
      const conflictFiles = files.filter((f) => f.startsWith(fileName));
      expect(conflictFiles.length).toBe(2);
      expect(conflictFiles).toContain(`${fileName}.jpg`);
      expect(conflictFiles.some((f) => f.match(/conflict-test-\d+\.jpg/))).toBe(
        true
      );
    }, 20000);
  });

  describe("å¸®åŠ©å’Œç‰ˆæœ¬ä¿¡æ¯æµ‹è¯•", () => {
    test("åº”è¯¥æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯", async () => {
      const result = await runCLI(["--help"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("ç”ŸæˆæŒ‡å®šä½“ç§¯çš„å›¾ç‰‡æ–‡ä»¶çš„å‘½ä»¤è¡Œå·¥å…·");
      expect(result.stdout).toContain("Usage:");
      expect(result.stdout).toContain("Options:");
      expect(result.stdout).toContain("-s, --size");
      expect(result.stdout).toContain("-f, --format");
      expect(result.stdout).toContain("-n, --name");
      expect(result.stdout).toContain("-o, --output");
      expect(result.stdout).toContain("ä½¿ç”¨ç¤ºä¾‹:");
    });

    test("åº”è¯¥æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯", async () => {
      const result = await runCLI(["--version"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("1.0.0");
    });

    test("åº”è¯¥æ˜¾ç¤ºçŸ­æ ¼å¼å¸®åŠ©", async () => {
      const result = await runCLI(["-h"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("ç”ŸæˆæŒ‡å®šä½“ç§¯çš„å›¾ç‰‡æ–‡ä»¶çš„å‘½ä»¤è¡Œå·¥å…·");
    });

    test("åº”è¯¥æ˜¾ç¤ºçŸ­æ ¼å¼ç‰ˆæœ¬", async () => {
      const result = await runCLI(["-v"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("1.0.0");
    });
  });

  describe("é”™è¯¯å¤„ç†æµ‹è¯•", () => {
    test("åº”è¯¥å¤„ç†æœªçŸ¥é€‰é¡¹", async () => {
      const result = await runCLI(["-s", "1", "--unknown-option"]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
      expect(result.stderr).toContain("ä½¿ç”¨ --help æŸ¥çœ‹ä½¿ç”¨è¯´æ˜");
    });

    test("åº”è¯¥å¤„ç†ç¼ºå°‘é€‰é¡¹å€¼", async () => {
      const result = await runCLI(["-s"]);

      expect(result.code).toBe(1);
      expect(result.stderr).toContain("é”™è¯¯");
    });

    test("åº”è¯¥å¤„ç†æ— æƒé™çš„è¾“å‡ºç›®å½•", async () => {
      // åœ¨Windowsä¸Šåˆ›å»ºåªè¯»ç›®å½•æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæ¨¡æ‹Ÿæµ‹è¯•
      if (process.platform !== "win32") {
        const readOnlyDir = path.join(tempDir, "readonly");
        await fs.mkdir(readOnlyDir);
        await fs.chmod(readOnlyDir, 0o444); // åªè¯»æƒé™

        const result = await runCLI(["-s", "1", "-o", readOnlyDir]);

        expect(result.code).toBe(2);
        expect(result.stderr).toContain("é”™è¯¯");

        // æ¢å¤æƒé™ä»¥ä¾¿æ¸…ç†
        await fs.chmod(readOnlyDir, 0o755);
      }
    });
  });

  describe("é•¿æ ¼å¼å‚æ•°æµ‹è¯•", () => {
    test("åº”è¯¥æ”¯æŒæ‰€æœ‰é•¿æ ¼å¼å‚æ•°", async () => {
      const result = await runCLI([
        "--size",
        "2",
        "--format",
        "png",
        "--name",
        "long-format-test",
        "--output",
        tempDir,
      ]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 2MB");
      expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼: PNG");
      expect(result.stdout).toContain("æ–‡ä»¶å: long-format-test");
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");

      const files = await fs.readdir(tempDir);
      expect(files).toContain("long-format-test.png");
    }, 15000);

    test("åº”è¯¥æ”¯æŒæ··åˆçŸ­é•¿æ ¼å¼å‚æ•°", async () => {
      const result = await runCLI([
        "-s",
        "1",
        "--format",
        "jpeg",
        "-n",
        "mixed-format",
        "--output",
        tempDir,
      ]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");

      const files = await fs.readdir(tempDir);
      expect(files).toContain("mixed-format.jpeg");
    }, 15000);
  });

  describe("è¾“å‡ºæ ¼å¼æµ‹è¯•", () => {
    test("åº”è¯¥åŒ…å«æ‰€æœ‰å¿…éœ€çš„è¾“å‡ºä¿¡æ¯", async () => {
      const result = await runCLI(["-s", "3", "-n", "output-test"]);

      expect(result.code).toBe(0);

      // æ£€æŸ¥å¯åŠ¨ä¿¡æ¯
      expect(result.stdout).toContain("ğŸš€ å¼€å§‹ç”Ÿæˆå›¾ç‰‡");
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯: 3MB");
      expect(result.stdout).toContain("å›¾ç‰‡æ ¼å¼: JPG");
      expect(result.stdout).toContain("æ–‡ä»¶å: output-test");

      // æ£€æŸ¥è¿›åº¦ä¿¡æ¯
      expect(result.stdout).toContain("â³");

      // æ£€æŸ¥æˆåŠŸä¿¡æ¯
      expect(result.stdout).toContain("âœ… æˆåŠŸ:");
      expect(result.stdout).toContain("å›¾ç‰‡ç”Ÿæˆå®Œæˆ");

      // æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
      expect(result.stdout).toContain("ğŸ“Š ç”Ÿæˆç»Ÿè®¡:");
      expect(result.stdout).toContain("ç›®æ ‡ä½“ç§¯:");
      expect(result.stdout).toContain("å®é™…ä½“ç§¯:");
      expect(result.stdout).toContain("ä½“ç§¯è¯¯å·®:");
      expect(result.stdout).toContain("å›¾ç‰‡å°ºå¯¸:");
      expect(result.stdout).toContain("è¿­ä»£æ¬¡æ•°:");
      expect(result.stdout).toContain("æ–‡ä»¶è·¯å¾„:");
    }, 15000);

    test("åº”è¯¥æ­£ç¡®æ˜¾ç¤ºæ–‡ä»¶è·¯å¾„", async () => {
      const result = await runCLI(["-s", "1", "-n", "path-test"]);

      expect(result.code).toBe(0);
      expect(result.stdout).toContain("æ–‡ä»¶è·¯å¾„:");
      expect(result.stdout).toContain("path-test.jpg");
    }, 15000);
  });
});
